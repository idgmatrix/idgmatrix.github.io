<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebGPU Triangle</title>
  <style>
    canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <canvas id="webgpuCanvas"></canvas>
  <script>
    async function init() {
      const canvas = document.getElementById("webgpuCanvas");
      const adapter = await navigator.gpu.requestAdapter();
      const device = await adapter.requestDevice();

      const context = canvas.getContext('gpupresent');
      
      const swapChainDescriptor = {
        device,
        format: 'bgra8unorm',
      };
      
      const swapChain = context.configureSwapChain(swapChainDescriptor);

      const shaderModuleDescriptor = {
        code: `[[stage(vertex)]]
        fn main([[builtin(vertex_index)]] VertexIndex: u32) -> [[builtin(position)]] vec4<f32> {
          var pos: array<vec2<f32>, 3> = array<vec2<f32>, 3>(
            vec2<f32>(0.0, 0.5),
            vec2<f32>(-0.5, -0.5),
            vec2<f32>(0.5, -0.5));
          return vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        }

        [[stage(fragment)]]
        fn main() -> [[location(0)]] vec4<f32> {
          return vec4<f32>(1.0, 0.0, 0.0, 1.0);
        }`,
      };
      
      const shaderModule = device.createShaderModule(shaderModuleDescriptor);

      const pipelineDescriptor = {
        vertex: {
          module: shaderModule,
          entryPoint: 'main',
        },
        fragment: {
          module: shaderModule,
          entryPoint: 'main',
          targets: [
            {
              format: 'bgra8unorm',
            },
          ],
        },
        primitive: {
          topology: 'triangle-list',
        },
      };

      const pipeline = device.createRenderPipeline(pipelineDescriptor);

      function frame() {
        const commandEncoderDescriptor = {};
        const commandEncoder = device.createCommandEncoder(commandEncoderDescriptor);
        
        const textureView = swapChain.getCurrentTexture().createView();
        const renderPassDescriptor = {
          colorAttachments: [
            {
              view: textureView,
              loadValue: [0, 0, 0, 1],
              storeOp: 'store',
            },
          ],
        };
        
        const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);
        passEncoder.setPipeline(pipeline);
        passEncoder.draw(3, 1, 0, 0);
        passEncoder.endPass();

        device.queue.submit([commandEncoder.finish()]);
        
        requestAnimationFrame(frame);
      }
      
      requestAnimationFrame(frame);
    }

    init();
  </script>
</body>
</html>
